<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA Güvenlik Sistemi - Güvenlik Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Montserrat', sans-serif; background: linear-gradient(135deg,#2c3e50,#34495e); color:#ecf0f1; overflow-x:hidden; }
.container { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:20px; transition: transform 0.3s ease; }
header { text-align:center; margin-bottom:20px; }
button { padding:12px 18px; margin:6px; border-radius:10px; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { opacity:0.9; }
#nobetAlBtn { background-color: #2980b9; color:#fff; }
#nobetBitirBtn { background-color: #c0392b; color:#fff; }
#devriyeStartBtn { background-color: #2980b9; color:#fff; }
#devriyeEndBtn { background-color: #c0392b; color:#fff; }
.status { margin:12px 0; padding:12px; background: rgba(0,0,0,0.2); border-radius:10px; width:100%; text-align:center; font-size:16px; }
.panel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); width:100%; margin-top:20px; }
.panel h2 { margin-top:0; text-align:center; }
.qr-list div { margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
.qr-list button.qrBtn { background-color: #7f8c8d; color:#fff; flex-shrink:0; width:120px; }
.qr-list button.qrBtn.read { background-color:#27ae60; }
input[type=date] { padding:6px; border-radius:8px; border:none; font-size:14px; }

/* Sağ panel ve profil */
#historyToggleBtn { position:fixed; top:20px; right:20px; background:#f39c12; color:#fff; border:none; border-radius:50%; width:50px; height:50px; font-size:24px; z-index:1001; cursor:pointer; display:flex; align-items:center; justify-content:center; }
#historyPanel { position:fixed; top:0; right:-100%; width:320px; height:100%; background: rgba(44,62,80,0.95); color:#fff; box-shadow: -6px 0 20px rgba(0,0,0,0.4); padding:20px; transition: right 0.3s ease; overflow-y:auto; z-index:1000; }
#historyPanel h2 { text-align:center; margin-top:0; }

.profileIcon { position:fixed; top:20px; left:20px; background:#16a085; color:#fff; border:none; border-radius:50%; width:50px; height:50px; font-size:24px; z-index:1001; cursor:pointer; display:flex; align-items:center; justify-content:center; }

/* QR modal */
#qrScannerModal { display:none; position:fixed; inset:0; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px; }
#qr-reader { width:100%; max-width:520px; }
#closeScanner { margin-top:20px; padding:12px 18px; border:none; border-radius:10px; background:#c0392b; color:#fff; font-weight:700; cursor:pointer; }
</style>
</head>
<body>

<!-- Profil ve geçmiş ikonları -->
<button class="profileIcon" id="profileBtn">&#128100;</button>
<button id="historyToggleBtn">&#128221;</button>

<!-- Sağ panel -->
<div id="historyPanel">
  <h2>Devriye Geçmişi</h2>
  <label for="filterDate">Tarih Filtrele:</label>
  <input type="date" id="filterDate">
  <div id="devriyeHistory"></div>
</div>

<!-- Profil modal -->
<div id="profileModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:9999; width:90%; max-width:400px;">
  <span id="profileClose" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff;">✖</span>
  <h3 style="text-align:center;">Profil</h3>
  <label>Kullanıcı Adı (değiştirilemez)</label>
  <input type="text" id="profileUsername" disabled style="width:100%; padding:8px; border-radius:8px; border:none; background:#333; color:#fff; font-weight:600;">
  <label>Eski Şifre</label>
  <input type="password" id="oldPassword" style="width:100%; padding:8px; border-radius:8px; border:none;">
  <label>Yeni Şifre</label>
  <input type="password" id="newPassword" style="width:100%; padding:8px; border-radius:8px; border:none;">
  <label>Telefon Numarası</label>
  <input type="text" id="phoneNumber" placeholder="+90..." style="width:100%; padding:8px; border-radius:8px; border:none;">
  <button id="updateProfileBtn" style="width:100%; padding:10px; margin-top:12px; border:none; border-radius:8px; background:#27ae60; color:#fff; font-weight:600;">Güncelle</button>
  <button id="logoutBtn" style="width:100%; padding:10px; margin-top:8px; border:none; border-radius:8px; background:#c0392b; color:#fff; font-weight:600;">Çıkış</button>
  <div id="profileMessage" style="margin-top:10px; font-size:14px;"></div>
</div>

<div class="container" id="mainContainer">
  <header>
    <h1>CGA Güvenlik Sistemi - Güvenlik Paneli</h1>
  </header>

  <!-- Nöbet -->
  <button id="nobetAlBtn">Nöbeti Teslim Al</button>
  <button id="nobetBitirBtn" disabled>Nöbeti Teslim Ettim</button>
  <div class="status" id="nobetStatus">Henüz nöbette değilsiniz.</div>

  <!-- Devriye -->
  <div class="panel">
    <h2>Devriye</h2>
    <button id="devriyeStartBtn">Devriye Başlat</button>
    <button id="devriyeEndBtn" disabled>Devriyeyi Bitir</button>
    <div class="status" id="devriyeStatus">Devriye başlamadı.</div>

    <h3>Devriye Noktaları</h3>
    <div class="qr-list" id="qrList"></div>
  </div>
</div>

<!-- QR Modal -->
<div id="qrScannerModal">
  <div id="qr-reader"></div>
  <button id="closeScanner">Kapat</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, push, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Session kontrol */
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || currentUser.type!=='security'){ alert("Güvenlik kullanıcı ile giriş yapmalısınız!"); window.location.href="login.html"; }

/* Panel elemanları */
const devriyeStartBtn = document.getElementById("devriyeStartBtn");
const devriyeEndBtn = document.getElementById("devriyeEndBtn");
const devriyeStatus = document.getElementById("devriyeStatus");
const qrListEl = document.getElementById("qrList");

/* QR modal */
const qrModal = document.getElementById('qrScannerModal');
const qrReaderDivId = 'qr-reader';
const closeScanner = document.getElementById('closeScanner');
let qrScanner = null;
let devriyeStarted=false, devriyeStartTime=null, readPoints=[];

/* Devriye - Firebase’den QR kodları ve devriye isimlerini çek */
async function loadDevriyePoints(){
  const snapshot = await get(ref(db,'qrCodes'));
  const points = snapshot.val() || {};
  qrListEl.innerHTML='';
  Object.values(points).forEach(p=>{
    const div=document.createElement('div');
    const btn=document.createElement('button'); btn.classList.add('qrBtn'); btn.dataset.qrId=p.qrId; btn.innerText='QR Okut';
    const span=document.createElement('span'); span.innerText=p.name;
    div.appendChild(btn); div.appendChild(span); qrListEl.appendChild(div);
    btn.addEventListener('click', ()=>{ startScanner(p.qrId, btn); });
  });
}
loadDevriyePoints();

/* Devriye başlat/bitir */
devriyeStartBtn.addEventListener('click', ()=>{
  if(devriyeStarted) return;
  devriyeStarted=true; devriyeStartTime=new Date();
  devriyeStatus.innerText='Devriye başladı: '+devriyeStartTime.toLocaleTimeString();
  devriyeEndBtn.disabled=false; readPoints=[];
  document.querySelectorAll('.qrBtn').forEach(b=>{ b.classList.remove('read'); b.innerText='QR Okut'; });
});

devriyeEndBtn.addEventListener('click', async ()=>{
  if(!devriyeStarted) return;
  const devriyeEndTime=new Date();
  const statusText=readPoints.length===document.querySelectorAll('.qrBtn').length ? "Tam devriye":"Eksik devriye";
  const devriyeRecord={
    user: currentUser.username,
    name: currentUser.name,
    date: devriyeStartTime.toISOString().split('T')[0],
    start: devriyeStartTime.toLocaleTimeString(),
    end: devriyeEndTime.toLocaleTimeString(),
    status: statusText,
    points:[...readPoints],
    timestamp: Date.now()
  };
  await push(ref(db,'devriyeHistory/'+currentUser.username), devriyeRecord);
  devriyeStarted=false; devriyeEndBtn.disabled=true; devriyeStatus.innerText='Devriye tamamlandı.';
  document.querySelectorAll('.qrBtn').forEach(b=>{ b.classList.remove('read'); b.innerText='QR Okut'; });
});

/* QR Scanner */
async function startScanner(expectedQrId, button){
  if(!devriyeStarted){ alert("Önce devriyeyi başlatmalısınız."); return; }
  qrModal.style.display='flex';
  try{ if(qrScanner){ await qrScanner.stop(); await qrScanner.clear(); } }catch(e){}
  qrScanner=new Html5Qrcode(qrReaderDivId);
  const config={fps:10, qrbox:{width:250,height:250}};
  qrScanner.start({ facingMode: "environment" }, config, qrCodeMessage=>{
    if(qrCodeMessage.includes(expectedQrId)){
      if(!readPoints.includes(expectedQrId)) readPoints.push(expectedQrId);
      button.classList.add('read'); button.innerText='Tamamlandı';
      qrScanner.stop(); qrModal.style.display='none';
    }else{ alert("Yanlış QR, doğru noktayı okutun!"); }
  }).catch(err=>{ console.error(err); });
}
closeScanner.addEventListener('click', async ()=>{
  if(qrScanner){ await qrScanner.stop(); await qrScanner.clear(); }
  qrModal.style.display='none';
});
</script>

</body>
</html>
