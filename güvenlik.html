<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA GÃ¼venlik Sistemi - GÃ¼venlik Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Montserrat', sans-serif; background: linear-gradient(135deg, #2c3e50, #34495e); color:#ecf0f1; overflow-x:hidden; }
.container { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:20px; transition: transform 0.3s ease; }
header { text-align:center; margin-bottom:20px; }
button { padding:12px 18px; margin:6px; border-radius:10px; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { opacity:0.9; }
#nobetAlBtn { background-color: #2980b9; color:#fff; }
#nobetBitirBtn { background-color: #c0392b; color:#fff; }
#devriyeStartBtn { background-color: #2980b9; color:#fff; }
#devriyeEndBtn { background-color: #c0392b; color:#fff; }
.status { margin:12px 0; padding:12px; background: rgba(0,0,0,0.2); border-radius:10px; width:100%; text-align:center; font-size:16px; }
.panel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); width:100%; margin-top:20px; }
.panel h2 { margin-top:0; text-align:center; }
.qr-list div { margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
.qr-list button.qrBtn { background-color: #7f8c8d; color:#fff; flex-shrink:0; width:100px; }
.qr-list button.qrBtn.read { background-color:#27ae60; }
input[type=date] { padding:6px; border-radius:8px; border:none; font-size:14px; }

/* Tek ikonlu saÄŸ panel */
#historyToggleBtn {
  position:fixed; top:20px; right:20px; background:#f39c12; color:#fff;
  border:none; border-radius:50%; width:50px; height:50px;
  font-size:24px; z-index:1001; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}

#historyPanel {
  position:fixed; top:0; right:-100%;
  width:320px; height:100%;
  background: rgba(44,62,80,0.95);
  color:#fff;
  box-shadow: -6px 0 20px rgba(0,0,0,0.4);
  padding:20px;
  transition: right 0.3s ease;
  overflow-y:auto;
  z-index:1000;
}

#historyPanel h2 { text-align:center; margin-top:0; }

.profileIcon {
  position:fixed; top:20px; left:20px; background:#16a085; color:#fff;
  border:none; border-radius:50%; width:50px; height:50px;
  font-size:24px; z-index:1001; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}

@media (min-width:600px){
  .container { max-width:600px; margin:auto; }
}
</style>
</head>
<body>

<!-- Profil ikonu -->
<button class="profileIcon" id="profileBtn">&#128100;</button>

<!-- Tek ikon: Devriye GeÃ§miÅŸi -->
<button id="historyToggleBtn">&#128221;</button> <!-- Liste ikonu (ðŸ“‘) -->

<div id="historyPanel">
  <h2>Devriye GeÃ§miÅŸi</h2>
  <label for="filterDate">Tarih Filtrele:</label>
  <input type="date" id="filterDate">
  <div id="devriyeHistory"></div>
</div>

<!-- Profil Modal -->
<div id="profileModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:9999; width:90%; max-width:400px;">
  <span id="profileClose" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff;">âœ–</span>
  <h3 style="text-align:center;">Profil</h3>
  
  <label>KullanÄ±cÄ± AdÄ± (deÄŸiÅŸtirilemez)</label>
  <input type="text" id="profileUsername" disabled style="width:100%; padding:8px; border-radius:8px; border:none; background:#333; color:#fff; font-weight:600;">
  
  <label>Eski Åžifre</label>
  <input type="password" id="oldPassword" style="width:100%; padding:8px; border-radius:8px; border:none;">
  
  <label>Yeni Åžifre</label>
  <input type="password" id="newPassword" style="width:100%; padding:8px; border-radius:8px; border:none;">
  
  <label>Telefon NumarasÄ±</label>
  <input type="text" id="phoneNumber" placeholder="+90..." style="width:100%; padding:8px; border-radius:8px; border:none;">
  
  <button id="updateProfileBtn" style="width:100%; padding:10px; margin-top:12px; border:none; border-radius:8px; background:#27ae60; color:#fff; font-weight:600;">GÃ¼ncelle</button>
  <button id="logoutBtn" style="width:100%; padding:10px; margin-top:8px; border:none; border-radius:8px; background:#c0392b; color:#fff; font-weight:600;">Ã‡Ä±kÄ±ÅŸ</button>

  <div id="profileMessage" style="margin-top:10px; font-size:14px;"></div>
</div>

<div class="container" id="mainContainer">
  <header>
    <h1>CGA GÃ¼venlik Sistemi - GÃ¼venlik Paneli</h1>
  </header>

  <!-- NÃ¶bet -->
  <button id="nobetAlBtn">NÃ¶beti Teslim Al</button>
  <button id="nobetBitirBtn" disabled>NÃ¶beti Teslim Ettim</button>
  <div class="status" id="nobetStatus">HenÃ¼z nÃ¶bette deÄŸilsiniz.</div>

  <!-- Devriye -->
  <div class="panel">
    <h2>Devriye</h2>
    <button id="devriyeStartBtn">Devriye BaÅŸlat</button>
    <button id="devriyeEndBtn" disabled>Devriyeyi Bitir</button>
    <div class="status" id="devriyeStatus">Devriye baÅŸlamadÄ±.</div>

    <h3>Devriye NoktalarÄ±</h3>
    <div class="qr-list">
      <div><button class="qrBtn" data-point="BahÃ§e">QR Okut</button><span>BahÃ§e</span></div>
      <div><button class="qrBtn" data-point="Otopark">QR Okut</button><span>Otopark</span></div>
      <div><button class="qrBtn" data-point="Arka BahÃ§e">QR Okut</button><span>Arka BahÃ§e</span></div>
      <div><button class="qrBtn" data-point="GiriÅŸ KapÄ±sÄ±">QR Okut</button><span>GiriÅŸ KapÄ±sÄ±</span></div>
      <div><button class="qrBtn" data-point="Yan BahÃ§e">QR Okut</button><span>Yan BahÃ§e</span></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || currentUser.type!=='security'){
  alert("GÃ¼venlik kullanÄ±cÄ± ile giriÅŸ yapmalÄ±sÄ±nÄ±z!");
  window.location.href="login.html";
}

// Profil modal ve ikonlarÄ±
const profileBtn = document.getElementById("profileBtn");
const profileModal = document.getElementById("profileModal");
const profileClose = document.getElementById("profileClose");
const profileUsername = document.getElementById("profileUsername");
const oldPassword = document.getElementById("oldPassword");
const newPassword = document.getElementById("newPassword");
const phoneNumber = document.getElementById("phoneNumber");
const updateProfileBtn = document.getElementById("updateProfileBtn");
const profileMessage = document.getElementById("profileMessage");
const logoutBtn = document.getElementById("logoutBtn");

profileUsername.value = currentUser.name;

profileBtn.addEventListener('click', ()=>{ profileModal.style.display='block'; });
profileClose.addEventListener('click', ()=>{ profileModal.style.display='none'; });

// Profil gÃ¼ncelleme
updateProfileBtn.addEventListener('click', async ()=>{
  profileMessage.innerText='';
  if(!oldPassword.value && !newPassword.value && !phoneNumber.value) return;

  const userRef = ref(db, 'users/'+currentUser.username);
  onValue(userRef, async snapshot=>{
    const user = snapshot.val();
    if(!user) return profileMessage.innerText="KullanÄ±cÄ± bulunamadÄ±.";
    if(oldPassword.value && oldPassword.value !== user.password) return profileMessage.innerText="Eski ÅŸifre hatalÄ±!";
    
    const updates = {};
    if(newPassword.value) updates.password = newPassword.value;
    if(phoneNumber.value) updates.phone = phoneNumber.value;

    await update(userRef, updates);
    profileMessage.innerText="Profil baÅŸarÄ±yla gÃ¼ncellendi!";
    oldPassword.value=''; newPassword.value=''; phoneNumber.value='';
    if(updates.password) currentUser.password = updates.password;
    if(updates.phone) currentUser.phone = updates.phone;
    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
  }, {onlyOnce:true});
});

// Ã‡Ä±kÄ±ÅŸ butonu
logoutBtn.addEventListener('click', ()=>{
  sessionStorage.removeItem('currentUser');
  window.location.href = "index.html";
});

// DiÄŸer gÃ¼venlik panel kodlarÄ±
const nobetAlBtn = document.getElementById("nobetAlBtn");
const nobetBitirBtn = document.getElementById("nobetBitirBtn");
const nobetStatus = document.getElementById("nobetStatus");
const devriyeStartBtn = document.getElementById("devriyeStartBtn");
const devriyeEndBtn = document.getElementById("devriyeEndBtn");
const devriyeStatus = document.getElementById("devriyeStatus");
const qrButtons = document.querySelectorAll('.qrBtn');
const devriyeHistoryEl = document.getElementById("devriyeHistory");
const filterDate = document.getElementById("filterDate");
const historyToggleBtn = document.getElementById("historyToggleBtn");
const historyPanel = document.getElementById("historyPanel");
const mainContainer = document.getElementById("mainContainer");

let devriyeStarted=false, devriyeStartTime=null, readPoints=[], allDevriyeHistory=[];
let historyOpen=false;

// NÃ¶bet durumu
const nobetRef = ref(db,'nobetDurumu/'+currentUser.username);
onValue(nobetRef, snapshot=>{
  const val = snapshot.val();
  if(val){
    if(val.status === 'started'){
      nobetStatus.innerText = `${val.user} ÅŸu anda nÃ¶bette.`;
      nobetAlBtn.disabled = true; nobetBitirBtn.disabled = false;
    } else if(val.status === 'ended'){
      nobetStatus.innerText = 'HenÃ¼z nÃ¶bette deÄŸilsiniz.';
      nobetAlBtn.disabled = false; nobetBitirBtn.disabled = true;
    }
  } else {
    nobetStatus.innerText = 'HenÃ¼z nÃ¶bette deÄŸilsiniz.';
    nobetAlBtn.disabled = false; nobetBitirBtn.disabled = true;
  }
});

// NÃ¶bet al/bitir
nobetAlBtn.addEventListener('click', ()=>{ set(nobetRef, { user: currentUser.name, status:'started' }); });
nobetBitirBtn.addEventListener('click', ()=>{ set(nobetRef, { user: currentUser.name, status:'ended' }); });

// Devriye baÅŸlat
devriyeStartBtn.addEventListener('click', ()=>{
  if(devriyeStarted) return;
  devriyeStarted=true;
  devriyeStartTime=new Date();
  devriyeStatus.innerText='Devriye baÅŸladÄ±: '+devriyeStartTime.toLocaleTimeString();
  devriyeEndBtn.disabled=false;
  readPoints=[];
  qrButtons.forEach(btn=>{ btn.classList.remove('read'); btn.nextElementSibling.innerText=btn.dataset.point; });
});

// QR okutma
qrButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(devriyeStarted && !readPoints.includes(btn.dataset.point)){
      readPoints.push(btn.dataset.point);
      btn.classList.add('read');
      btn.nextElementSibling.innerText=btn.dataset.point+" - TamamlandÄ±";
      devriyeStatus.innerText=`Okutulan noktalar: ${readPoints.join(', ')}`;
    }
  });
});

// Devriyeyi bitir
devriyeEndBtn.addEventListener('click', ()=>{
  if(!devriyeStarted) return;
  const devriyeEndTime=new Date();
  let statusText = readPoints.length===qrButtons.length ? "Tam devriye":"Eksik devriye";
  const weekday = devriyeStartTime.toLocaleDateString('tr-TR',{ weekday:'long' });
  const dateText = `${devriyeStartTime.toLocaleDateString()} (${weekday.charAt(0).toUpperCase()+weekday.slice(1)})`;

  const devriyeRecord = {
    user: currentUser.username,
    name: currentUser.name,
    date: devriyeStartTime.toISOString().split('T')[0],
    displayDate: dateText,
    start: devriyeStartTime.toLocaleTimeString(),
    end: devriyeEndTime.toLocaleTimeString(),
    status: statusText,
    points:[...readPoints],
    timestamp: serverTimestamp()
  };

  push(ref(db,'devriyeHistory/'+currentUser.username), devriyeRecord);
  devriyeStarted=false;
  devriyeEndBtn.disabled=true;
  devriyeStatus.innerText='Devriye tamamlandÄ±.';
  qrButtons.forEach(btn=>{ btn.classList.remove('read'); btn.nextElementSibling.innerText=btn.dataset.point; });
});

// Devriye geÃ§miÅŸini dinle
onValue(ref(db,'devriyeHistory/'+currentUser.username), snapshot=>{
  const val = snapshot.val();
  allDevriyeHistory = val ? Object.values(val).sort((a,b)=>b.timestamp-a.timestamp):[];
  renderDevriyeHistory();
});

function renderDevriyeHistory(){
  const selectedDate = filterDate.value;
  devriyeHistoryEl.innerHTML='';
  const filtered = selectedDate ? allDevriyeHistory.filter(d=>d.date===selectedDate):allDevriyeHistory;
  filtered.forEach(d=>{
    const item=document.createElement('div');
    item.classList.add('devriye-item');
    item.style.marginBottom='10px';
    item.style.padding='10px';
    item.style.background='rgba(44,62,80,0.6)';
    item.style.borderRadius='10px';
    item.style.fontSize='14px';
    item.innerHTML=`<strong>Tarih:</strong> ${d.displayDate}<br>
                    <strong>BaÅŸlangÄ±Ã§:</strong> ${d.start}<br>
                    <strong>BitiÅŸ:</strong> ${d.end}<br>
                    <strong>Durum:</strong> ${d.status}<br>
                    <strong>Noktalar:</strong> ${d.points.join(', ')}`;
    devriyeHistoryEl.appendChild(item);
  });
}
filterDate.addEventListener('change', renderDevriyeHistory);

// Tek ikon ile aÃ§/kapa
historyToggleBtn.addEventListener('click', ()=>{
  if(historyPanel.style.right==='0px'){
    historyPanel.style.right='-100%';
    mainContainer.style.transform='translateX(0)';
  } else {
    historyPanel.style.right='0';
    mainContainer.style.transform='translateX(-270px)';
  }
});
</script>
</body>
</html>
