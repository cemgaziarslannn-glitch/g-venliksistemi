<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA Güvenlik Sistemi - Güvenlik Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Montserrat', sans-serif; background: linear-gradient(135deg, #2c3e50, #34495e); color:#ecf0f1; overflow-x:hidden; }
  .container { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:20px; transition: transform 0.3s ease; }
  header { text-align:center; margin-bottom:20px; }
  button { padding:12px 18px; margin:6px; border-radius:10px; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
  button:hover { opacity:0.9; }
  #nobetAlBtn { background-color: #2980b9; color:#fff; }
  #nobetBitirBtn { background-color: #c0392b; color:#fff; }
  #devriyeStartBtn { background-color: #2980b9; color:#fff; }
  #devriyeEndBtn { background-color: #c0392b; color:#fff; }
  .status { margin:12px 0; padding:12px; background: rgba(0,0,0,0.2); border-radius:10px; width:100%; text-align:center; font-size:16px; }
  .panel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); width:100%; margin-top:20px; }
  .panel h2 { margin-top:0; text-align:center; }
  .qr-list div { margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
  .qr-list span.completed { color: #2ecc71; font-weight:600; }
  input[type=date] { padding:6px; border-radius:8px; border:none; font-size:14px; }
  #historyToggleBtn, .profileIcon { position:fixed; top:20px; border:none; border-radius:50%; width:50px; height:50px; font-size:24px; z-index:1001; cursor:pointer; display:flex; align-items:center; justify-content:center; }
  #historyToggleBtn { right:20px; background:#f39c12; color:#fff; }
  .profileIcon { left:20px; background:#16a085; color:#fff; }
  #historyPanel { position:fixed; top:0; right:-100%; width:320px; height:100%; background: rgba(44,62,80,0.95); color:#fff; box-shadow: -6px 0 20px rgba(0,0,0,0.4); padding:20px; transition: right 0.3s ease; overflow-y:auto; z-index:1000; }
  #historyPanel h2 { text-align:center; margin-top:0; }
  @media (min-width:600px){ .container { max-width:600px; margin:auto; } }
</style>
</head>
<body>

<button class="profileIcon" id="profileBtn">&#128100;</button>
<button id="historyToggleBtn">&#128221;</button>

<div id="historyPanel">
  <h2>Devriye Geçmişi</h2>
  <label for="filterDate">Tarih Filtrele:</label>
  <input type="date" id="filterDate">
  <div id="devriyeHistory"></div>
</div>

<div id="profileModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:9999; width:90%; max-width:400px;">
  <span id="profileClose" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff;">✖</span>
  <h3 style="text-align:center;">Profil</h3>
  
  <label>Kullanıcı Adı (değiştirilemez)</label>
  <input type="text" id="profileUsername" disabled style="width:100%; padding:8px; border-radius:8px; border:none; background:#333; color:#fff; font-weight:600;">
  
  <label>Eski Şifre</label>
  <input type="password" id="oldPassword" style="width:100%; padding:8px; border-radius:8px; border:none;">
  
  <label>Yeni Şifre</label>
  <input type="password" id="newPassword" style="width:100%; padding:8px; border-radius:8px; border:none;">
  
  <label>Telefon Numarası</label>
  <input type="text" id="phoneNumber" placeholder="+90..." style="width:100%; padding:8px; border-radius:8px; border:none;">
  
  <button id="updateProfileBtn" style="width:100%; padding:10px; margin-top:12px; border:none; border-radius:8px; background:#27ae60; color:#fff; font-weight:600;">Güncelle</button>
  <button id="logoutBtn" style="width:100%; padding:10px; margin-top:8px; border:none; border-radius:8px; background:#c0392b; color:#fff; font-weight:600;">Çıkış</button>

  <div id="profileMessage" style="margin-top:10px; font-size:14px;"></div>
</div>

<div class="container" id="mainContainer">
  <header>
    <h1>CGA Güvenlik Sistemi - Güvenlik Paneli</h1>
  </header>

  <button id="nobetAlBtn">Nöbeti Teslim Al</button>
  <button id="nobetBitirBtn" disabled>Nöbeti Teslim Ettim</button>
  <div class="status" id="nobetStatus">Henüz nöbette değilsiniz.</div>

  <div class="panel">
    <h2>Devriye</h2>
    <button id="devriyeStartBtn">Devriye Başlat</button>
    <button id="devriyeEndBtn" disabled>Devriyeyi Bitir</button>
    <div class="status" id="devriyeStatus">Devriye başlamadı.</div>

    <h3>Devriye Noktaları</h3>
    <div class="qr-list" id="qrList">
      <!-- FreeBSD’den dinamik doldurulacak -->
    </div>
    <button id="singleQrBtn" style="background:#2980b9;color:#fff;width:100%;padding:12px;border-radius:10px;border:none;margin-top:10px;">QR Okut</button>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, update, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* === Firebase === */
const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* === Session kontrol === */
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || currentUser.type!=='security'){
  alert("Güvenlik kullanıcı ile giriş yapmalısınız!");
  window.location.href="login.html";
}

/* === Profil işlemleri === */
const profileBtn = document.getElementById("profileBtn");
const profileModal = document.getElementById("profileModal");
const profileClose = document.getElementById("profileClose");
const profileUsername = document.getElementById("profileUsername");
const oldPassword = document.getElementById("oldPassword");
const newPassword = document.getElementById("newPassword");
const phoneNumber = document.getElementById("phoneNumber");
const updateProfileBtn = document.getElementById("updateProfileBtn");
const profileMessage = document.getElementById("profileMessage");
const logoutBtn = document.getElementById("logoutBtn");

profileUsername.value = currentUser.name || currentUser.username || "";
profileBtn.addEventListener('click', ()=>{ profileModal.style.display='block'; });
profileClose.addEventListener('click', ()=>{ profileModal.style.display='none'; });
updateProfileBtn.addEventListener('click', async ()=>{
  profileMessage.innerText='';
  if(!oldPassword.value && !newPassword.value && !phoneNumber.value) return;
  const key = currentUser.username;
  const userRef = ref(db, 'users/'+key);
  const snapshot = await get(userRef);
  const user = snapshot.val();
  if(!user){ profileMessage.innerText="Kullanıcı bulunamadı."; return; }
  if(oldPassword.value && oldPassword.value !== user.password){
    profileMessage.innerText="Eski şifre hatalı!"; return;
  }
  const updates = {};
  if(newPassword.value) updates.password = newPassword.value;
  if(phoneNumber.value) updates.phone = phoneNumber.value;
  await update(userRef, updates);
  profileMessage.innerText="Profil başarıyla güncellendi!";
  oldPassword.value=''; newPassword.value=''; phoneNumber.value='';
  if(updates.password) currentUser.password = updates.password;
  if(updates.phone) currentUser.phone = updates.phone;
  sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
});
logoutBtn.addEventListener('click', ()=>{ sessionStorage.removeItem('currentUser'); window.location.href = "index.html"; });

/* === Panel elemanları === */
const nobetAlBtn = document.getElementById("nobetAlBtn");
const nobetBitirBtn = document.getElementById("nobetBitirBtn");
const nobetStatus = document.getElementById("nobetStatus");
const devriyeStartBtn = document.getElementById("devriyeStartBtn");
const devriyeEndBtn = document.getElementById("devriyeEndBtn");
const devriyeStatus = document.getElementById("devriyeStatus");
const devriyeHistoryEl = document.getElementById("devriyeHistory");
const filterDate = document.getElementById("filterDate");
const historyToggleBtn = document.getElementById("historyToggleBtn");
const historyPanel = document.getElementById("historyPanel");
const mainContainer = document.getElementById("mainContainer");
const qrList = document.getElementById("qrList");
const singleQrBtn = document.getElementById("singleQrBtn");

/* === Devriye akışı === */
let devriyeStarted=false, readPoints=[], allDevriyeHistory=[];

const nobetRef = ref(db,'nobetDurumu/'+(currentUser.username || currentUser.name));
onValue(nobetRef, snapshot=>{
  const val = snapshot.val();
  if(val){
    if(val.status === 'started'){
      nobetStatus.innerText = `${val.user} şu anda nöbette.`;
      nobetAlBtn.disabled = true; nobetBitirBtn.disabled = false;
    } else {
      nobetStatus.innerText = 'Henüz nöbette değilsiniz.';
      nobetAlBtn.disabled = false; nobetBitirBtn.disabled = true;
    }
  } else {
    nobetStatus.innerText = 'Henüz nöbette değilsiniz.';
    nobetAlBtn.disabled = false; nobetBitirBtn.disabled = true;
  }
});
nobetAlBtn.addEventListener('click', ()=>{ set(nobetRef, { user: currentUser.name || currentUser.username, status:'started' }); });
nobetBitirBtn.addEventListener('click', ()=>{ set(nobetRef, { user: currentUser.name || currentUser.username, status:'ended' }); });

devriyeStartBtn.addEventListener('click', ()=>{
  if(devriyeStarted) return;
  devriyeStarted=true;
  devriyeStatus.innerText='Devriye başladı';
  readPoints=[];
  qrList.querySelectorAll('span').forEach(s=>{ s.classList.remove('completed'); s.innerText=s.dataset.name; });
});
devriyeEndBtn.addEventListener('click', ()=>{
  if(!devriyeStarted) return;
  let statusText = readPoints.length===qrList.children.length ? "Tam devriye":"Eksik devriye";
  const devriyeRecord = {
    user: currentUser.username || currentUser.name,
    name: currentUser.name || currentUser.username,
    date: new Date().toISOString().split('T')[0],
    start: new Date().toLocaleTimeString(),
    end: new Date().toLocaleTimeString(),
    status: statusText,
    points:[...readPoints],
    timestamp: Date.now()
  };
  push(ref(db,'devriyeHistory/'+(currentUser.username || currentUser.name)), devriyeRecord);
  devriyeStarted=false;
  devriyeEndBtn.disabled=true;
  devriyeStatus.innerText='Devriye tamamlandı.';
  qrList.querySelectorAll('span').forEach(s=>{ s.classList.remove('completed'); s.innerText=s.dataset.name; });
});

/* === FreeBSD’den noktaları çek ve listele === */
async function loadFreeBSDPoints(){
  // Örnek veri yerine gerçek FreeBSD fetch kodu kullanılacak
  const freebsdData = {
    "qrCodes": {
      "arka_bahce_1755312557198": { "firma":"CGA", "name":"ARKA BAHCE", "qrId":"arka_bahce_1755312557198" },
      "otopark_1755312560000": { "firma":"CGA", "name":"OTOPARK", "qrId":"otopark_1755312560000" },
      "giris_kapisi_1755312570000": { "firma":"CGA", "name":"GIRIS KAPISI", "qrId":"giris_kapisi_1755312570000" }
    }
  };
  qrList.innerHTML='';
  Object.values(freebsdData.qrCodes).forEach(point=>{
    const div = document.createElement('div');
    div.innerHTML = `<span data-qrid="${point.qrId}" data-name="${point.name}">${point.name}</span>`;
    qrList.appendChild(div);
  });
}
loadFreeBSDPoints();

/* === QR okutma === */
let qrScanner = null;
singleQrBtn.addEventListener('click', async ()=>{
  if(!devriyeStarted){ alert("Önce devriyeyi başlatmalısınız."); return; }
  if(typeof Html5Qrcode === 'undefined'){ alert("QR kütüphanesi yüklenemedi."); return; }

  if(qrScanner){ try{ await qrScanner.stop(); await qrScanner.clear(); }catch(e){} }
  const qrReaderDiv = document.createElement('div');
  qrReaderDiv.id='qr-reader-temp';
  qrReaderDiv.style.position='fixed';
  qrReaderDiv.style.top='50%';
  qrReaderDiv.style.left='50%';
  qrReaderDiv.style.transform='translate(-50%,-50%)';
  qrReaderDiv.style.zIndex='9999';
  qrReaderDiv.style.background='#000';
  qrReaderDiv.style.padding='10px';
  qrReaderDiv.style.borderRadius='10px';
  qrReaderDiv.style.maxWidth='400px';
  qrReaderDiv.style.width='90%';
  document.body.appendChild(qrReaderDiv);

  qrScanner = new Html5Qrcode('qr-reader-temp');
  qrScanner.start({facingMode:"environment"},{fps:10, qrbox:250},
    async (qrMessage)=>{
      try{ await qrScanner.stop(); await qrScanner.clear(); }catch(e){}
      qrReaderDiv.remove();
      const matched = qrList.querySelector(`span[data-qrid="${qrMessage}"]`);
      if(matched){
        matched.classList.add('completed');
        matched.innerText = matched.dataset.name + ' - Tamamlandı';
        readPoints.push(qrMessage);
        devriyeStatus.innerText = `Okutulan noktalar: ${readPoints.join(', ')}`;
      }else{ alert("Bilinmeyen QR kod"); }
    },
    (errMsg)=>{}
  ).catch(err=>{
    console.error("QR açılamadı", err);
    qrReaderDiv.remove();
    alert("Kamera açılamadı");
  });
});

/* === Devriye geçmişi dinle === */
onValue(ref(db,'devriyeHistory/'+(currentUser.username || currentUser.name)), snapshot=>{
  const val = snapshot.val();
  allDevriyeHistory = val ? Object.values(val).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)) : [];
  renderDevriyeHistory();
});
function renderDevriyeHistory(){
  const selectedDate = filterDate.value;
  devriyeHistoryEl.innerHTML='';
  allDevriyeHistory.forEach(record=>{
    if(selectedDate && record.date!==selectedDate) return;
    const div = document.createElement('div');
    div.style.borderBottom='1px solid #fff';
    div.style.padding='6px 0';
    div.innerHTML = `<b>${record.date}</b> | ${record.start}-${record.end} | ${record.status} <br> Noktalar: ${record.points.join(', ')}`;
    devriyeHistoryEl.appendChild(div);
  });
}
filterDate.addEventListener('change', renderDevriyeHistory);
historyToggleBtn.addEventListener('click', ()=>{ 
  if(historyPanel.style.right==='0px'){ historyPanel.style.right='-100%'; }
  else{ historyPanel.style.right='0px'; }
});
</script>
</body>
</html>
