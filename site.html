<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA G√ºvenlik Sistemi - Site Sakini Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Montserrat', sans-serif; background: linear-gradient(135deg, #1f3c59, #2c5364); color:#ecf0f1; }
.container { max-width: 1000px; margin:20px auto; padding:20px; }
h1,h2 { text-align:center; margin-bottom:0; }
.panel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); margin-top:20px; }
.status { margin-top:10px; padding:15px; background: rgba(0,0,0,0.2); border-radius:12px; font-size:15px; line-height:1.5; }
.devriye-list { max-height:450px; overflow-y:auto; margin-top:10px; }
.devriye-item { display:flex; flex-direction:column; background: rgba(0,0,0,0.2); border-radius:12px; margin-bottom:12px; padding:12px; transition:0.3s; }
.devriye-item:hover { background: rgba(0,0,0,0.35); }
.devriye-left { flex:1; min-width:180px; margin-right:10px; }
.devriye-status { font-weight:bold; font-size:16px; text-align:center; min-width:140px; padding:8px; border-radius:12px; margin-top:10px; }
.devriye-status.tam { background: #2ecc71; color:#fff; }
.devriye-status.eksik { background: #e74c3c; color:#fff; }
.devriye-points { margin-top:8px; font-size:14px; background: rgba(255,255,255,0.05); padding:6px; border-radius:8px; }

/* Aktif g√ºvenlik kutularƒ± */
.security-item {
  display:flex;
  align-items:center;
  justify-content: space-between;
  background: rgba(0,0,0,0.2);
  padding:8px 12px;
  border-radius:10px;
  margin-bottom:6px;
  font-size:15px;
  transition:0.3s;
}
.security-item:hover { background: rgba(0,0,0,0.35); }
.security-left { display:flex; align-items:center; gap:10px; }
.security-light { width:10px; height:10px; background:#2ecc71; border-radius:50%; flex-shrink:0; }
.security-name { font-weight:600; }
.call-btn { background:#27ae60; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; }
.call-btn:hover { background:#2ecc71; }

@media (min-width:600px){
  .devriye-item { flex-direction: row; justify-content: space-between; align-items: center; }
  .devriye-left { margin-right:20px; }
  .devriye-status { margin-top:0; }
}

/* Mobil uyumlu ayarlar */
@media (max-width:600px){
  .security-item {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
  }
  .call-btn { align-self: auto; }
}

input[type=date] { padding:6px; border-radius:8px; border:none; outline:none; margin-top:5px; }
</style>
</head>
<body>

<div class="container">
  <h1>CGA G√ºvenlik Sistemi</h1>
  <h2>Site Sakini Paneli</h2>

  <!-- G√ºvenlik Durumu -->
  <div class="panel">
    <h3>G√ºvenlik Durumu</h3>
    <div id="securityStatus" class="status">Y√ºkleniyor...</div>
  </div>

  <!-- Devriye Ge√ßmi≈üi -->
  <div class="panel">
    <h3>Devriye Ge√ßmi≈üi</h3>
    <label for="filterDate">Tarih Filtrele:</label>
    <input type="date" id="filterDate">
    <div class="devriye-list" id="devriyeHistory"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const securityStatus = document.getElementById("securityStatus");
const devriyeHistoryEl = document.getElementById("devriyeHistory");
const filterDate = document.getElementById("filterDate");

let allDevriyeHistory = [];

// T√ºrkiye saatine g√∂re bug√ºn√ºn tarihi
function getTurkeyToday(){
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset()*60000);
  const turkeyOffset = 3*60*60*1000;
  const turkeyTime = new Date(utc + turkeyOffset);
  const year = turkeyTime.getFullYear();
  const month = String(turkeyTime.getMonth()+1).padStart(2,'0');
  const day = String(turkeyTime.getDate()).padStart(2,'0');
  return `${year}-${month}-${day}`;
}

// Filtreyi bug√ºn√ºn tarihine ayarla
filterDate.value = getTurkeyToday();

// Sayfa a√ßƒ±kken gece yarƒ±sƒ± otomatik tarih g√ºncelleme
setInterval(()=>{
  const today = getTurkeyToday();
  if(filterDate.value !== today){
    filterDate.value = today;
    renderDevriyeHistory();
  }
}, 60*1000); // Her dakika kontrol

// Aktif g√ºvenlikler ve ‚ÄúG√ºvenliƒüi Ara‚Äù butonu
onValue(ref(db,'nobetDurumu'), snapshot=>{
  const val = snapshot.val();
  securityStatus.innerHTML = '';
  if(val){
    let count=0;
    for(const key in val){
      if(val[key].status==='started'){
        const userName = val[key].user;
        const userRef = ref(db,'users/' + userName);

        onValue(userRef, userSnap=>{
          if(!userSnap.exists()) return;
          const userData = userSnap.val();
          const phone = userData?.phone || '';
          
          const div = document.createElement('div');
          div.classList.add('security-item');
          div.innerHTML = `
            <div class="security-left">
              <div class="security-light"></div>
              <div class="security-name">${userName} N√∂bette</div>
            </div>
            <button class="call-btn" onclick="window.location.href='tel:${phone}'">
              üìûAra
            </button>
          `;
          securityStatus.appendChild(div);
        }, {onlyOnce:true});
        count++;
      }
    }
    if(count===0) securityStatus.innerText = '≈ûu anda n√∂bette g√ºvenlik yok.';
  } else {
    securityStatus.innerText = '≈ûu anda n√∂bette g√ºvenlik yok.';
  }
});

// Devriye ge√ßmi≈üi
onValue(ref(db,'devriyeHistory'), snapshot=>{
  const val = snapshot.val();
  allDevriyeHistory = [];
  if(val){
    for(const userKey in val){
      const userRecords = val[userKey];
      for(const recordKey in userRecords){
        const record = userRecords[recordKey];
        allDevriyeHistory.push({
          ...record,
          userName: record.name
        });
      }
    }
    // Timestamp sƒ±rasƒ±na g√∂re ters sƒ±rala
    allDevriyeHistory.sort((a,b)=>b.timestamp - a.timestamp);
  }
  renderDevriyeHistory();
});

// Devriye tarihlerini T√ºrkiye saatine g√∂re filtreleme
function renderDevriyeHistory(){
  const selectedDate = filterDate.value;
  devriyeHistoryEl.innerHTML = '';

  const filtered = allDevriyeHistory.filter(d=>{
    const ts = d.timestamp;
    const dateObj = new Date(ts);
    const utc = dateObj.getTime() + (dateObj.getTimezoneOffset()*60000);
    const turkeyOffset = 3*60*60*1000;
    const turkeyTime = new Date(utc + turkeyOffset);
    const year = turkeyTime.getFullYear();
    const month = String(turkeyTime.getMonth()+1).padStart(2,'0');
    const day = String(turkeyTime.getDate()).padStart(2,'0');
    const devriyeDateStr = `${year}-${month}-${day}`;
    return selectedDate ? devriyeDateStr === selectedDate : true;
  });

  filtered.forEach(d=>{
    const div = document.createElement('div');
    div.classList.add('devriye-item');

    const left = document.createElement('div');
    left.classList.add('devriye-left');

    let pointsHTML = '';
    if(d.status.toLowerCase().includes('eksik')){
      const tumNoktalar = ["Bah√ße","Otopark","Arka Bah√ße","Giri≈ü Kapƒ±sƒ±","Yan Bah√ße"];
      const isaretlenmeyen = tumNoktalar.filter(p => !(d.points || []).includes(p));
      pointsHTML = `<div class="devriye-points"><strong>Eksik Noktalar:</strong> ${isaretlenmeyen.join(', ')}</div>`;
    }

    left.innerHTML = `
      <div style="display:flex; gap:6px;"><strong>G√ºvenlik:</strong> ${d.userName}</div>
      <div style="display:flex; gap:6px;"><strong>Tarih:</strong> ${d.displayDate}</div>
      <div style="display:flex; gap:6px;"><strong>Ba≈ülangƒ±√ß:</strong> ${d.start}</div>
      <div style="display:flex; gap:6px;"><strong>Biti≈ü:</strong> ${d.end}</div>
      ${pointsHTML}
    `;

    const status = document.createElement('div');
    status.classList.add('devriye-status');
    if(d.status.toLowerCase().includes('tam')){
      status.classList.add('tam');
      status.innerHTML = 'TAM DEVREYE<br>‚úÖ';
    } else {
      status.classList.add('eksik');
      status.innerHTML = 'EKSƒ∞K DEVREYE<br>‚ùå';
    }

    div.appendChild(left);
    div.appendChild(status);
    devriyeHistoryEl.appendChild(div);
  });
}

filterDate.addEventListener('change', renderDevriyeHistory);
</script>

</body>
</html>
