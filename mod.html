<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stabil Admin Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {margin:0; font-family:'Roboto',sans-serif; background:#1f2a38; color:#e0e0e0; min-height:100vh; padding:30px; display:flex; justify-content:center;}
.panel-wrapper {width:95%; max-width:1200px; display:grid; grid-template-columns: 1fr 1fr; gap:20px;}
.panel {background:#222f3e; border-radius:15px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,0.5); transition:0.3s;}
.panel:hover {transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.6);}
.panel h2 {margin-top:0; margin-bottom:15px; color:#ffcc00; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;}
input, select {width:100%; padding:10px; margin:6px 0; border-radius:10px; border:none; background:#1a2b3a; color:#fff;}
input:focus, select:focus {outline:none; box-shadow:0 0 10px #ffcc00;}
button {padding:10px 18px; border:none; border-radius:12px; font-weight:500; cursor:pointer; transition:0.3s; margin-top:8px;}
button:hover {opacity:0.85;}
#createUserBtn {background:#27ae60; color:#fff;}
.bulkBtn {background:#3498db; color:#fff; margin-right:5px;}
#bulkDeleteBtn {background:#e74c3c; color:#fff;}
.delete {background:#e74c3c; color:#fff; margin-right:5px;}
.edit {background:#9b59b6; color:#fff;}
table {width:100%; border-collapse:collapse; margin-top:10px;}
th, td {padding:12px; text-align:left; background:#1a2b3a; border-bottom:1px solid rgba(255,255,255,0.15); transition:0.2s;}
th {background:#2c3e50; color:#ffcc00; text-transform:uppercase;}
tr:hover {background: rgba(52,152,219,0.2);}
header {grid-column: span 2; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;}
header h1 {color:#ffcc00; margin:0; font-size:2rem;}
header button {background:#e67e22; color:#fff;}
#createMsg, #bulkMsg, #searchMsg, #devriyeMsg {margin-top:8px; color:#2ecc71; font-weight:500;}
.modal {display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center;}
.modal-content {background:#1f2a38; padding:20px; border-radius:12px; width:320px; display:flex; flex-direction:column; gap:10px;}
.modal-content input {margin:0;}
.modal-content button {margin-top:10px;}
</style>
</head>
<body>

<div class="panel-wrapper">

<header>
  <h1>Stabil Admin Paneli</h1>
  <div>
    <button id="devriyeBtn" style="background:#2980b9; color:#fff; margin-right:10px;">Devriye Ekle</button>
    <button id="logoutBtn">Çıkış</button>
  </div>
</header>

<div class="panel">
<h2>Yeni Kullanıcı Oluştur</h2>
<select id="newBlock">
  <option value="A">Blok A</option>
  <option value="B">Blok B</option>
  <option value="C">Blok C</option>
  <option value="D">Blok D</option>
  <option value="E">Blok E</option>
  <option value="F">Blok F</option>
  <option value="G">Blok G</option>
  <option value="H">Blok H</option>
  <option value="I">Blok I</option>
</select>
<input type="text" id="newApartment" placeholder="Daire Numarası">
<input type="password" id="newPassword" placeholder="Şifre (otomatik kullanıcı adıyla aynı)">
<select id="newType">
  <option value="resident">Site Sakini</option>
  <option value="security">Güvenlik</option>
  <option value="admin">Admin</option>
</select>
<input type="text" id="newPhone" placeholder="Telefon">
<button id="createUserBtn">Oluştur</button>
<div id="createMsg"></div>
</div>

<div class="panel">
<h2>Toplu Site Sakini İşlemleri</h2>
<select id="bulkBlock">
  <option value="A">Blok A</option>
  <option value="B">Blok B</option>
  <option value="C">Blok C</option>
  <option value="D">Blok D</option>
  <option value="E">Blok E</option>
  <option value="F">Blok F</option>
  <option value="G">Blok G</option>
  <option value="H">Blok H</option>
  <option value="I">Blok I</option>
</select>
<div>
<button class="bulkBtn" data-count="50">50 ekle</button>
<button class="bulkBtn" data-count="100">100 ekle</button>
<button class="bulkBtn" data-count="150">150 ekle</button>
<button class="bulkBtn" data-count="200">200 ekle</button>
<button class="bulkBtn" data-count="250">250 ekle</button>
<button class="bulkBtn" data-count="300">300 ekle</button>
<button id="bulkDeleteBtn">Toplu Sil</button>
</div>
<div id="bulkMsg"></div>
</div>

<div class="panel">
<h2>Kullanıcı Ara</h2>
<input type="text" id="searchInput" placeholder="Daire Numarası veya kullanıcı adı">
<button id="searchBtn">Ara</button>
<div id="searchMsg"></div>
</div>

<div class="panel" style="grid-column: span 2;">
<h2>Tüm Kullanıcılar</h2>
<select id="userFilter" style="margin-bottom:10px;">
<option value="all">Tümü</option>
<option value="Güvenlik">Güvenlik</option>
<option value="Site Sakini">Site Sakini</option>
<option value="Admin">Admin</option>
</select>
<table>
<thead>
<tr><th>Daire Numarası</th><th>Blok</th><th>Tip</th><th>Şifre</th><th>Telefon</th><th>İşlem</th></tr>
</thead>
<tbody id="usersTable"></tbody>
</table>
</div>

<div class="panel">
<h2>Devriye İşlemleri</h2>
<button id="resetDevriyeBtn">Sıfırla</button>
<button id="exportDevriyeBtn">Dışa Aktar</button>
<div id="devriyeMsg"></div>
</div>

</div>

<div id="editModal" class="modal">
<div class="modal-content">
<h3>Düzenle</h3>
<label>Daire Numarası</label>
<input type="text" id="editApartment" disabled>
<label>Şifre</label>
<input type="text" id="editPassword">
<label>Telefon</label>
<input type="text" id="editPhone">
<button id="saveEditBtn">Kaydet</button>
<button id="closeEditBtn">Kapat</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, set, remove, onValue, get, update } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Yetki kontrolü
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || currentUser.type.toLowerCase()!=="admin"){
  alert("Yetkisiz erişim!");
  window.location.href="index.html";
}

// Çıkış
document.getElementById('logoutBtn').addEventListener('click', ()=> {
  sessionStorage.removeItem('currentUser');
  window.location.href='index.html';
});

// Devriye Ekle butonu
document.getElementById('devriyeBtn').addEventListener('click', () => {
  window.location.href = 'devriye.html';
});

// Kullanıcı listeleme
const usersTable = document.getElementById('usersTable');
let allUsers = {};

function mapType(type){
  if(type==="resident") return "Site Sakini";
  if(type==="security") return "Güvenlik";
  if(type==="admin") return "Admin";
  return type;
}

function listUsers(filter="all"){
  const usersRef = ref(db,'users');
  onValue(usersRef,snapshot=>{
    const val = snapshot.val() || {};
    allUsers = val;
    usersTable.innerHTML="";
    Object.values(val)
      .filter(u => filter==="all" || mapType(u.type)===filter)
      .sort((a,b)=>{
        const numA = parseInt(a.username.replace(a.block,''));
        const numB = parseInt(b.username.replace(b.block,''));
        if(a.block===b.block) return numA - numB;
        return a.block.localeCompare(b.block);
      })
      .forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.username}</td>
                        <td>${u.block||''}</td>
                        <td>${mapType(u.type)}</td>
                        <td>${u.password}</td>
                        <td>${u.phone||''}</td>
                        <td>
                          <button class="edit" data-username="${u.username}">Düzenle</button>
                          <button class="delete" data-username="${u.username}">Sil</button>
                        </td>`;
        usersTable.appendChild(tr);
      });
    attachRowEvents();
  });
}

function attachRowEvents(){
  document.querySelectorAll('.delete').forEach(btn=>{
    btn.onclick = async () => {
      if(confirm('Kullanıcı silinsin mi?')){
        await remove(ref(db,'users/'+btn.dataset.username));
      }
    }
  });
  document.querySelectorAll('.edit').forEach(btn=>{
    btn.onclick = () => {
      const user = allUsers[btn.dataset.username];
      document.getElementById('editApartment').value = user.username;
      document.getElementById('editPassword').value = user.password;
      document.getElementById('editPhone').value = user.phone||'';
      document.getElementById('editModal').style.display = "flex";
    }
  });
}

listUsers();
document.getElementById('userFilter').addEventListener('change', e=> {
  listUsers(e.target.value);
});

// Yeni kullanıcı oluştur
document.getElementById('createUserBtn').addEventListener('click', async ()=> {
  const block = document.getElementById('newBlock').value;
  const apartment = document.getElementById('newApartment').value.trim();
  const password = apartment; // Şifre kullanıcı adıyla aynı
  const type = document.getElementById('newType').value;
  const phone = document.getElementById('newPhone').value.trim();

  if(!apartment){ 
    document.getElementById('createMsg').innerText="Eksik bilgi!"; 
    return;
  }

  await set(ref(db,'users/'+apartment), {
    username: apartment,
    password: password,
    type: type,
    block: block,
    phone: phone
  });

  document.getElementById('createMsg').innerText="Kullanıcı oluşturuldu!";
  document.getElementById('newBlock').selectedIndex = 0;
  document.getElementById('newApartment').value="";
  document.getElementById('newPassword').value="";
  document.getElementById('newType').selectedIndex = 0;
  document.getElementById('newPhone').value="";
});

// Toplu kullanıcı ekleme
async function addBulkUsers(count){
  const block = document.getElementById('bulkBlock').value;
  const snapshot = await get(ref(db,'users'));
  const val = snapshot.val() || {};
  const existingNums = Object.values(val)
    .filter(u=>u.block===block)
    .map(u=>parseInt(u.username.replace(block,'')))
    .filter(n=>!isNaN(n));
  let start = existingNums.length>0 ? Math.max(...existingNums)+1 : 1;

  for(let i=start;i<start+count;i++){
    const username = block + i;
    await set(ref(db,'users/'+username), {username, password: username, type:'resident', block, phone:''});
  }
}

document.querySelectorAll('.bulkBtn').forEach(btn=>{
  btn.addEventListener('click', async ()=> {
    const count = parseInt(btn.dataset.count);
    await addBulkUsers(count);
    document.getElementById('bulkMsg').innerText=`${count} kullanıcı eklendi!`;
  });
});

// Toplu silme
document.getElementById('bulkDeleteBtn').addEventListener('click', async ()=> {
  if(confirm('Tüm kullanıcılar silinsin mi?')){
    await remove(ref(db,'users'));
    document.getElementById('bulkMsg').innerText="Tüm kullanıcılar silindi!";
  }
});

// Kullanıcı düzenleme modal
document.getElementById('closeEditBtn').addEventListener('click', ()=> {document.getElementById('editModal').style.display="none";});
document.getElementById('saveEditBtn').addEventListener('click', async ()=> {
  const username = document.getElementById('editApartment').value;
  const password = document.getElementById('editPassword').value;
  const phone = document.getElementById('editPhone').value;
  await update(ref(db,'users/'+username), {password, phone});
  document.getElementById('editModal').style.display="none";
});

// Kullanıcı arama
document.getElementById('searchBtn').addEventListener('click', ()=> {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  if(!query){document.getElementById('searchMsg').innerText="Arama boş!"; return;}
  const result = Object.values(allUsers).filter(u=>u.username.toLowerCase().includes(query));
  if(result.length===0){document.getElementById('searchMsg').innerText="Kullanıcı bulunamadı!"; usersTable.innerHTML="";} 
  else {
    document.getElementById('searchMsg').innerText=`${result.length} kullanıcı bulundu.`;
    usersTable.innerHTML="";
    result.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.username}</td>
                      <td>${u.block||''}</td>
                      <td>${mapType(u.type)}</td>
                      <td>${u.password}</td>
                      <td>${u.phone||''}</td>
                      <td>
                        <button class="edit" data-username="${u.username}">Düzenle</button>
                        <button class="delete" data-username="${u.username}">Sil</button>
                      </td>`;
      usersTable.appendChild(tr);
    });
    attachRowEvents();
  }
});
</script>
</body>
</html>
